jobs:
  digest:
    name: Acquire digest of the latest image
    outputs:
      llvm: ${{ steps.llvm.outputs.digest }}
    runs-on: ubuntu-latest
    steps:
      - id: llvm
        name: Acquire digest of the latest snowstep/llvm
        run: |
          digest=$(
            curl -s https://hub.docker.com/v2/namespaces/snowstep/repositories/llvm/tags \
              | jq -cr '[.results[]|select(.name=="latest").images[]|select(.architecture=="amd64")]|max_by(.last_pushed).digest'
          )
          printf 'digest=%s\n' $digest | tee -a $GITHUB_OUTPUT
        shell: bash
  dockerhub:
    name: See the latest snowstep/apt-fast on DockerHub
    outputs:
      OUTDATED: ${{ steps.dockerhub-llvm.outputs.OUTDATED }}
    runs-on: ubuntu-latest
    steps:
      - id: dockerhub-llvm
        name: Compare the latest updates between snowstep/apt-fast and snowstep/llvm
        run: |
          api=https://hub.docker.com/v2/namespaces/snowstep/repositories
          for repo in apt-fast llvm; do
            last=$(curl -s $api/$repo/tags | jq -cr '.results[]|select(.name=="latest").last_updated')
            printf '%s=%s\n' $repo $last >&2
            date --date=$last "+%s"
          done | xargs | {
            read latest_apt_fast latest_llvm
            printf 'apt_fast=%s\n' $latest_apt_fast >&2
            printf 'llvm=%s\n' $latest_llvm >&2
            boolean=(true false)
            outdated=$([[ $latest_apt_fast -gt $latest_llvm ]]; echo $?)
            echo OUTDATED=${boolean[$outdated]}
          } | tee -a $GITHUB_OUTPUT
        shell: bash
  llvm:
    container:
      image: snowstep/llvm@${{ needs.digest.outputs.llvm }}
    name: See the latest LLVM release
    needs:
      - digest
    outputs:
      MAJOR_VERSION: ${{ steps.llvm.outputs.MAJOR_VERSION }}
      OUTDATED: ${{ steps.llvm.outputs.OUTDATED }}
    runs-on: ubuntu-latest
    steps:
      - id: llvm
        name: Compare currently installed version with the latest llvm
        run: |
          local=$(clang --version | grep version | grep -E '[0-9]{14}' -o | head -n1)
          printf 'clang version (installed): %s\n' $local >&2
          codename=$(grep -e '^VERSION_CODENAME=' /etc/os-release)
          codename=${codename#*=}
          printf 'codename=%s\n' $codename >&2
          repo=https://apt.llvm.org/$codename/dists/llvm-toolchain-$codename
          aria2c --quiet $repo/main/binary-amd64/Packages.gz
          declare -A dep
          declare -A ver
          name=
          while read line; do
            key=${line%%:\ *}
            value=${line#*:\ }
            case $key in
              Depends) dep[$name]=${value%%\ *};;
              Package) name=$value;;
              Version) ver[$name]=$(grep -E '[0-9]{14}' -o <<< $value | head -n1);;
            esac
          done <<< $(gzip -cd Packages.gz)
          echo MAJOR_VERSION=${dep[clang]#*-} | tee -a $GITHUB_OUTPUT
          latest=${ver[${dep[clang]}]}
          printf 'clang version (latest): %s\n' $latest >&2
          boolean=(true false)
          outdated=$([[ $latest -gt $local ]]; echo $?)
          echo OUTDATED=${boolean[$outdated]} | tee -a $GITHUB_OUTPUT
        shell: bash
  publish-if-outdated:
    if: ${{ needs.dockerhub.outputs.OUTDATED == 'true' || needs.llvm.outputs.OUTDATED == 'true' }}
    name: Publish if outdated
    needs:
      - dockerhub
      - llvm
    secrets:
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
    uses: ./.github/workflows/publish.yml
    with:
      MAJOR_VERSION: ${{ needs.llvm.outputs.MAJOR_VERSION }}
name: Check updates
on:
  schedule:
    - cron: '15 */12 * * *'
  workflow_dispatch:
